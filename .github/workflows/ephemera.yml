name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  issues: write
  pull-requests: write

env:
  GCP_PROJECT_ID: ephemera-dev-2025
  GKE_CLUSTER: ephemera-dev
  GKE_REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev/ephemera-dev-2025/ephemera

jobs:
  create-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create Preview Environment
        id: create-env
        run: |
          # Call Ephemera API to create preview environment
          RESPONSE=$(curl -k -X POST https://ephemera-api.devpreview.app/api/v1/environments/ \
            -H "Content-Type: application/json" \
            -d '{
              "repository_full_name": "${{ github.repository }}",
              "repository_name": "${{ github.event.repository.name }}",
              "pr_number": ${{ github.event.pull_request.number }},
              "pr_title": "${{ github.event.pull_request.title }}",
              "branch_name": "${{ github.event.pull_request.head.ref }}",
              "commit_sha": "${{ github.event.pull_request.head.sha }}",
              "installation_id": 0,
              "user_id": ${{ github.event.pull_request.user.id }},
              "user_login": "${{ github.event.pull_request.user.login }}",
              "user_avatar_url": "${{ github.event.pull_request.user.avatar_url }}"
            }')

          echo "API Response: $RESPONSE"

          # Extract environment URL from response
          ENV_URL=$(echo $RESPONSE | jq -r '.environment_url')
          NAMESPACE=$(echo $RESPONSE | jq -r '.namespace')

          echo "Preview Environment: $ENV_URL"
          echo "Namespace: $NAMESPACE"

          # Export for next steps
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
          echo "env_url=$ENV_URL" >> $GITHUB_OUTPUT

      - name: Get GCP Credentials from Ephemera
        id: get-creds
        run: |
          # Fetch GCP credentials from Ephemera API using token
          CREDS=$(curl -s -H "Authorization: Bearer ${{ secrets.EPHEMERA_TOKEN }}" \
            https://ephemera-api.devpreview.app/api/v1/credentials/gcp | jq -r '.credentials_json')

          echo "GCP credentials retrieved successfully"
          # Save to output (masking sensitive data)
          echo "creds<<EOF" >> $GITHUB_OUTPUT
          echo "$CREDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ steps.get-creds.outputs.creds }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY }}/${{ github.event.repository.name }}:pr-${{ github.event.pull_request.number }}-${{ github.sha }}"
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy to Kubernetes
        run: |
          NAMESPACE="${{ steps.create-env.outputs.namespace }}"
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY }}/${{ github.event.repository.name }}:pr-${{ github.event.pull_request.number }}-${{ github.sha }}"

          # Create deployment with resource requests
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ github.event.repository.name }}
            namespace: $NAMESPACE
            labels:
              app: ${{ github.event.repository.name }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ${{ github.event.repository.name }}
            template:
              metadata:
                labels:
                  app: ${{ github.event.repository.name }}
              spec:
                containers:
                - name: ${{ github.event.repository.name }}
                  image: $IMAGE_TAG
                  ports:
                  - containerPort: 80
                  resources:
                    requests:
                      cpu: "100m"
                      memory: "128Mi"
                    limits:
                      cpu: "500m"
                      memory: "512Mi"
          EOF

          # Create service
          kubectl expose deployment ${{ github.event.repository.name }} \
            --port=80 \
            --target-port=80 \
            --namespace=$NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f - -n $NAMESPACE

          # Create ingress
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: ${{ github.event.repository.name }}
            namespace: $NAMESPACE
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              kubernetes.io/ingress.class: nginx
          spec:
            tls:
            - hosts:
              - $NAMESPACE.devpreview.app
              secretName: $NAMESPACE-tls
            rules:
            - host: $NAMESPACE.devpreview.app
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: ${{ github.event.repository.name }}
                      port:
                        number: 80
          EOF

          # Wait for deployment to be ready
          kubectl rollout status deployment/${{ github.event.repository.name }} -n $NAMESPACE --timeout=5m

      - name: Comment on PR - Provisioning
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoName = context.payload.repository.name;
            const namespace = `pr-${prNumber}-${repoName}`;
            const envUrl = `https://${namespace}.devpreview.app`;

            const body = [
              '## Preview Environment Created',
              '',
              'Your preview environment is being provisioned...',
              '',
              `**Environment URL**: ${envUrl}`,
              `**Namespace**: \`${namespace}\``,
              '**Status**: Provisioning',
              '',
              '> This usually takes 2-3 minutes. The URL will be accessible once deployment completes.',
              '',
              '---',
              '*Powered by Ephemera*'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR - Deployment Complete
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoName = context.payload.repository.name;
            const namespace = `pr-${prNumber}-${repoName}`;
            const envUrl = `https://${namespace}.devpreview.app`;

            const body = [
              '## Deployment Complete',
              '',
              'Your preview environment is now live and ready to use!',
              '',
              `**Live URL**: [${envUrl}](${envUrl})`,
              `**Namespace**: \`${namespace}\``,
              '**Status**: Ready',
              '',
              '### What was deployed:',
              `- Docker image: \`${{ github.event.repository.name }}:pr-${prNumber}-${{ github.sha }}\``,
              `- Commit: \`${{ github.event.pull_request.head.sha }}\``,
              `- Branch: \`${{ github.event.pull_request.head.ref }}\``,
              '',
              '---',
              '*Powered by Ephemera*'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  destroy-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Get GCP Credentials from Ephemera
        id: get-creds
        run: |
          # Fetch GCP credentials from Ephemera API using token
          CREDS=$(curl -s -H "Authorization: Bearer ${{ secrets.EPHEMERA_TOKEN }}" \
            https://ephemera-api.devpreview.app/api/v1/credentials/gcp | jq -r '.credentials_json')

          echo "GCP credentials retrieved successfully"
          # Save to output (masking sensitive data)
          echo "creds<<EOF" >> $GITHUB_OUTPUT
          echo "$CREDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ steps.get-creds.outputs.creds }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Delete Preview Environment
        run: |
          NAMESPACE="pr-${{ github.event.pull_request.number }}-${{ github.event.repository.name }}"

          echo "Deleting preview environment: $NAMESPACE"

          # Delete the namespace (this will delete all resources within it)
          kubectl delete namespace $NAMESPACE --ignore-not-found=true

          echo "Preview environment deleted successfully"

      - name: Delete Environment from API
        run: |
          # Call Ephemera API to mark environment as deleted
          curl -k -X DELETE https://ephemera-api.devpreview.app/api/v1/environments/${{ github.repository }}/${{ github.event.pull_request.number }}/ || true

      - name: Comment on PR - Environment Destroyed
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoName = context.payload.repository.name;
            const namespace = `pr-${prNumber}-${repoName}`;

            const body = [
              '## Preview Environment Destroyed',
              '',
              'The preview environment has been cleaned up.',
              '',
              `**Namespace**: \`${namespace}\` (deleted)`,
              '**Status**: Destroyed',
              '',
              '---',
              '*Powered by Ephemera*'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
